# API ê´€ë ¨ ì»¨ë²¤ì…˜ ë¬¸ì„œ

ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì˜ API í˜¸ì¶œ, ìƒíƒœ ê´€ë¦¬, TanStack Query ì‚¬ìš©ì— ëŒ€í•œ ì»¨ë²¤ì…˜ì„ ì •ë¦¬í•œ ë¬¸ì„œì…ë‹ˆë‹¤.

## ğŸ“‹ ëª©ì°¨

1. [ì „ì²´ êµ¬ì¡°](#ì „ì²´-êµ¬ì¡°)
2. [í•µì‹¬ íŒ¨í„´](#í•µì‹¬-íŒ¨í„´)
3. [íŒŒì¼ êµ¬ì¡° ë° ë„¤ì´ë° ê·œì¹™](#íŒŒì¼-êµ¬ì¡°-ë°-ë„¤ì´ë°-ê·œì¹™)
4. [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)
5. [ì—ëŸ¬ ì²˜ë¦¬](#ì—ëŸ¬-ì²˜ë¦¬)
6. [ì¿¼ë¦¬ ê´€ë¦¬](#ì¿¼ë¦¬-ê´€ë¦¬)
7. [Supabase í™œìš©](#supabase-í™œìš©)
8. [ì˜ˆì œ ì½”ë“œ](#ì˜ˆì œ-ì½”ë“œ)

---

## ì „ì²´ êµ¬ì¡°

í”„ë¡œì íŠ¸ì˜ API ê´€ë ¨ êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê³„ì¸µìœ¼ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤:

```
Hook (useQuery/useMutation)
  â†“
Store (Zustand - ìƒíƒœ ê´€ë¦¬)
  â†“
Supabase Client (ì§ì ‘ í˜¸ì¶œ)
  â†“
Supabase Database
```

### ì—­í•  ë¶„ë‹´

-   **Hook**: TanStack Queryì˜ `useQuery`/`useMutation`ì„ ì‚¬ìš©í•˜ì—¬ ì¿¼ë¦¬ ìƒì„± ë° ê´€ë¦¬
-   **Store**: Zustandë¥¼ ì‚¬ìš©í•œ ì „ì—­ ìƒíƒœ ê´€ë¦¬
-   **Supabase Client**: Hookì˜ `queryFn`/`mutationFn`ì—ì„œ Supabaseë¡œ ì§ì ‘ ë°ì´í„° í˜¸ì¶œ
-   **Supabase Database**: PostgreSQL ê¸°ë°˜ ë°ì´í„°ë² ì´ìŠ¤, Row Level Security(RLS) ì ìš©

---

## í•µì‹¬ íŒ¨í„´

### 1. Query íŒ¨í„´ (ë°ì´í„° ì¡°íšŒ)

Hookì—ì„œ `useQuery`ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ê³ , ì„±ê³µ ì‹œ Storeì— ìƒíƒœë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

**íŠ¹ì§•:**

-   `queryKey`ì— ì˜ì¡´ì„± ê°’ë“¤ì„ í¬í•¨í•˜ì—¬ ìºì‹± ê´€ë¦¬
-   `queryFn`ì—ì„œ Supabase Clientë¡œ ì§ì ‘ í˜¸ì¶œ
-   `useEffect`ë¥¼ í†µí•´ ì„±ê³µ ì‹œ Store ìƒíƒœ ì—…ë°ì´íŠ¸
-   `enabled` ì˜µì…˜ìœ¼ë¡œ ì¡°ê±´ë¶€ ì‹¤í–‰ ì œì–´

**ì˜ˆì œ:**

```typescript
export const useUsers = (enabled: boolean = true) => {
    const setUsers = useUserStore((state) => state.setUsers);

    const queryResult = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            const { data, error } = await supabase.from('users').select('*').order('created_at', { ascending: false });

            if (error) {
                throw error;
            }

            return data;
        },
        enabled,
    });

    useEffect(() => {
        if (queryResult.data && queryResult.isSuccess) {
            setUsers(queryResult.data);
        }
    }, [queryResult.data, queryResult.isSuccess, setUsers]);

    return queryResult;
};
```

### 2. Mutation íŒ¨í„´ (ë°ì´í„° ë³€ê²½)

Hookì—ì„œ `useMutation`ì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ìƒì„±/ìˆ˜ì •/ì‚­ì œí•©ë‹ˆë‹¤.

**íŠ¹ì§•:**

-   `mutationFn`ì—ì„œ Supabase Clientë¡œ ì§ì ‘ í˜¸ì¶œ
-   `onSuccess`ì—ì„œ Store ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™”
-   `onError`ì—ì„œ ì—ëŸ¬ ì²˜ë¦¬

**ì˜ˆì œ:**

```typescript
export const useAddUser = () => {
    const addUser = useUserStore((state) => state.addUser);

    return useMutation({
        mutationFn: async (newUser: { name: string; email: string }) => {
            const { data, error } = await supabase.from('users').insert([newUser]).select().single();

            if (error) {
                throw error;
            }

            return data;
        },
        onSuccess: (data) => {
            addUser(data);
            queryClient.invalidateQueries({ queryKey: ['users'] });
            toast.success('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        onError: (error: any) => {
            toast.error('ì‚¬ìš©ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            console.error('Add user error:', error);
        },
    });
};
```

### 3. Store êµ¬ì¡° (Zustand)

Zustandë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì—­ ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

**ê¸°ë³¸ íŒ¨í„´:**

```typescript
interface UserStore {
    users: User[];
    setUsers: (users: User[]) => void;
    addUser: (user: User) => void;
    updateUser: (id: string, user: Partial<User>) => void;
    removeUser: (id: string) => void;
    reset: () => void;
}

const initialState = {
    users: [],
};

const useUserStore = create<UserStore>((set) => ({
    ...initialState,
    setUsers: (users: User[]) => set({ users }),
    addUser: (user: User) =>
        set((state) => ({
            users: [...state.users, user],
        })),
    updateUser: (id: string, updatedUser: Partial<User>) =>
        set((state) => ({
            users: state.users.map((user) => (user.id === id ? { ...user, ...updatedUser } : user)),
        })),
    removeUser: (id: string) =>
        set((state) => ({
            users: state.users.filter((user) => user.id !== id),
        })),
    reset: () => set(initialState),
}));
```

**ì£¼ì˜ì‚¬í•­:**

-   StoreëŠ” ì£¼ë¡œ ìƒíƒœ ì €ì¥ ë° ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë¥¼ ì œê³µí•©ë‹ˆë‹¤
-   API í˜¸ì¶œì€ Hookì—ì„œ ì²˜ë¦¬í•˜ê³ , StoreëŠ” ìƒíƒœ ê´€ë¦¬ë§Œ ë‹´ë‹¹í•©ë‹ˆë‹¤

### 4. TanStack Query ì„¤ì •

ì „ì—­ QueryClient ì„¤ì •ì€ `app/_lib/shared/tanstack/queryClient.ts`ì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.

**ì£¼ìš” ì„¤ì •:**

-   `staleTime`: 5ë¶„ (ë°ì´í„°ê°€ fresh ìƒíƒœë¡œ ìœ ì§€ë˜ëŠ” ì‹œê°„)
-   `gcTime`: 10ë¶„ (ê°€ë¹„ì§€ ì»¬ë ‰ì…˜ ì‹œê°„)
-   `retry`: 4xx ì—ëŸ¬ëŠ” ì¬ì‹œë„í•˜ì§€ ì•ŠìŒ, ìµœëŒ€ 2ë²ˆê¹Œì§€ ì¬ì‹œë„
-   `refetchOnWindowFocus`: true (ë¸Œë¼ìš°ì € í¬ì»¤ìŠ¤ ì‹œ ìë™ ë¦¬í˜ì¹˜)
-   `refetchOnReconnect`: true (ë„¤íŠ¸ì›Œí¬ ì¬ì ‘ì† ì‹œ ìë™ ë¦¬í˜ì¹˜)

**ì—ëŸ¬ ì²˜ë¦¬:**

-   Query ì—ëŸ¬: `QueryCache.onError`ì—ì„œ ì „ì—­ ì²˜ë¦¬
-   Mutation ì—ëŸ¬: `MutationCache.onError`ì—ì„œ ì „ì—­ ì²˜ë¦¬

---

## íŒŒì¼ êµ¬ì¡° ë° ë„¤ì´ë° ê·œì¹™

### ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
app/
â”œâ”€â”€ _lib/
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ hooks/              # Hook íŒŒì¼ë“¤
â”‚       â”‚   â”œâ”€â”€ common/
â”‚       â”‚   â”œâ”€â”€ user/
â”‚       â”‚   â””â”€â”€ product/
â”‚       â”œâ”€â”€ stores/             # Store íŒŒì¼ë“¤
â”‚       â”‚   â”œâ”€â”€ user/
â”‚       â”‚   â”œâ”€â”€ product/
â”‚       â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ supabase/
â”‚       â”‚   â””â”€â”€ client.ts       # Supabase í´ë¼ì´ì–¸íŠ¸
â”‚       â”œâ”€â”€ tanstack/
â”‚       â”‚   â””â”€â”€ queryClient.ts  # TanStack Query ì„¤ì •
â”‚       â”œâ”€â”€ type/
â”‚       â”‚   â””â”€â”€ database.types.ts # Supabase íƒ€ì… ì •ì˜
â”‚       â””â”€â”€ providers/
â”‚           â””â”€â”€ QueryProvider.tsx # Query Provider
```

### ë„¤ì´ë° ê·œì¹™

#### Hook íŒŒì¼

-   **ê²½ë¡œ**: `app/_lib/shared/hooks/{ë„ë©”ì¸}/{ê¸°ëŠ¥}Hook.ts`
-   **ì˜ˆì‹œ**:
    -   `useUserHook.ts`
    -   `useProductHook.ts`
    -   `usePostHook.ts`

#### Hook í•¨ìˆ˜

-   **Query**: `use{ê¸°ëŠ¥ëª…}` (ë³µìˆ˜í˜•)
    -   ì˜ˆ: `useUsers`, `useProducts`, `usePosts`
-   **Mutation**: `use{ë™ì‚¬}{ê¸°ëŠ¥ëª…}`
    -   ì˜ˆ: `useAddUser`, `useUpdateUser`, `useDeleteUser`

#### Store íŒŒì¼

-   **ê²½ë¡œ**: `app/_lib/shared/stores/{ë„ë©”ì¸}/use{ê¸°ëŠ¥}Store.ts`
-   **ì˜ˆì‹œ**:
    -   `useUserStore.ts`
    -   `useProductStore.ts`
    -   `usePostStore.ts`

#### Store ë³€ìˆ˜ëª…

-   **Store Hook**: `use{ê¸°ëŠ¥}Store`
    -   ì˜ˆ: `useUserStore`, `useProductStore`

#### Query Key

-   **í˜•ì‹**: `['ê¸°ëŠ¥ëª…', ...ì˜ì¡´ì„±ê°’ë“¤]`
-   **ì˜ˆì‹œ**:
    -   `['users']`
    -   `['users', userId]`
    -   `['products', categoryId, page]`

---

## ë°ì´í„° íë¦„

### Query íë¦„ (ë°ì´í„° ì¡°íšŒ)

```
1. ì»´í¬ë„ŒíŠ¸ì—ì„œ Hook í˜¸ì¶œ
   â†“
2. Hookì˜ useQuery ì‹¤í–‰
   â†“
3. queryFnì—ì„œ Supabase Clientë¡œ ë°ì´í„° ì¡°íšŒ
   â†“
4. Supabase Databaseì—ì„œ ë°ì´í„° ë°˜í™˜
   â†“
5. useEffectì—ì„œ Store ìƒíƒœ ì—…ë°ì´íŠ¸
   â†“
6. ì»´í¬ë„ŒíŠ¸ì— ë°ì´í„° ë°˜í™˜
```

### Mutation íë¦„ (ë°ì´í„° ë³€ê²½)

```
1. ì»´í¬ë„ŒíŠ¸ì—ì„œ Hookì˜ mutation í˜¸ì¶œ
   â†“
2. mutationFnì—ì„œ Supabase Clientë¡œ ë°ì´í„° ë³€ê²½
   â†“
3. Supabase Databaseì—ì„œ ì²˜ë¦¬ ë° ë°˜í™˜
   â†“
4. onSuccess ì‹¤í–‰
   â”œâ”€ Store ìƒíƒœ ì—…ë°ì´íŠ¸
   â””â”€ ê´€ë ¨ ì¿¼ë¦¬ ë¬´íš¨í™” (invalidateQueries)
   â†“
5. ìë™ìœ¼ë¡œ ê´€ë ¨ ì¿¼ë¦¬ ë¦¬í˜ì¹˜
```

---

## ì—ëŸ¬ ì²˜ë¦¬

### Query ì—ëŸ¬ ì²˜ë¦¬

**Hook ë ˆë²¨:**

```typescript
queryFn: async () => {
    const { data, error } = await supabase.from('users').select('*');

    if (error) {
        throw error; // ì—ëŸ¬ë¥¼ ê·¸ëŒ€ë¡œ throw
    }

    return data;
};
```

**ì „ì—­ ë ˆë²¨ (queryClient.ts):**

```typescript
queryCache: new QueryCache({
    onError: (error: any, query) => {
        console.error('Query Error:', {
            error: error.message || error,
            queryKey: query.queryKey,
            timestamp: new Date().toISOString(),
        });

        if (!query.meta?.skipErrorToast) {
            toast.error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    },
});
```

### Mutation ì—ëŸ¬ ì²˜ë¦¬

**Hook ë ˆë²¨:**

```typescript
onError: (error: any) => {
    toast.error('ì‘ì—…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    console.error('Mutation error:', error);
};
```

**ì „ì—­ ë ˆë²¨ (queryClient.ts):**

```typescript
mutationCache: new MutationCache({
    onError: (error: any, variables, context, mutation) => {
        console.error('Mutation Error:', {
            error: error.message || error,
            mutationKey: mutation.options.mutationKey,
            variables,
            timestamp: new Date().toISOString(),
        });

        if (!mutation.meta?.skipErrorToast) {
            toast.error('ì‘ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    },
});
```

**ì£¼ì˜ì‚¬í•­:**

-   API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°ì´í„°ë¡œ ë³€í™˜í•˜ì§€ ì•Šê³  ì—ëŸ¬ë¥¼ ê·¸ëŒ€ë¡œ ì „ë‹¬í•©ë‹ˆë‹¤
-   í•˜ë“œì½”ë”©ëœ ëŒ€ì²´ ë°ì´í„°ëŠ” ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤

---

## ì¿¼ë¦¬ ê´€ë¦¬

### ì¿¼ë¦¬ ë¬´íš¨í™” (Invalidation)

Mutation ì„±ê³µ ì‹œ ê´€ë ¨ ì¿¼ë¦¬ë¥¼ ë¬´íš¨í™”í•˜ì—¬ ìë™ìœ¼ë¡œ ë¦¬í˜ì¹˜í•©ë‹ˆë‹¤.

```typescript
onSuccess: (data) => {
    addUser(data);
    queryClient.invalidateQueries({ queryKey: ['users'] });
};
```

### ì¿¼ë¦¬ í‚¤ ì„¤ê³„ ì›ì¹™

1. **ì˜ì¡´ì„± í¬í•¨**: ì¿¼ë¦¬ ê²°ê³¼ì— ì˜í–¥ì„ ì£¼ëŠ” ëª¨ë“  ê°’ í¬í•¨

    ```typescript
    queryKey: ['products', categoryId, page, limit];
    ```

2. **ê³„ì¸µ êµ¬ì¡° í™œìš©**: ê´€ë ¨ ì¿¼ë¦¬ë“¤ì„ ê·¸ë£¹í™”

    ```typescript
    queryKey: ['users']; // ëª¨ë“  users ì¿¼ë¦¬
    queryKey: ['users', userId]; // íŠ¹ì • userì˜ ì¿¼ë¦¬
    ```

3. **ìºì‹œ ì œì–´**: íŠ¹ì • ì¿¼ë¦¬ì˜ ìºì‹œ ì„¤ì • ë³€ê²½
    ```typescript
    queryClient.setQueryDefaults(['users', 'realtime'], {
        staleTime: 0,
        gcTime: 0,
    });
    ```

### Signal ì‚¬ìš© (ìš”ì²­ ì·¨ì†Œ)

AbortSignalì„ ì‚¬ìš©í•˜ì—¬ ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ìš”ì²­ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.

```typescript
queryFn: async ({ signal }) => {
    const { data, error } = await supabase.from('users').select('*').abortSignal(signal);

    if (error) throw error;
    return data;
};
```

---

## Supabase í™œìš©

### 1. ê¸°ë³¸ CRUD ì‘ì—…

#### SELECT (ì¡°íšŒ)

```typescript
const { data, error } = await supabase
    .from('users')
    .select('*')
    .eq('status', 'active')
    .order('created_at', { ascending: false })
    .limit(10);
```

#### INSERT (ì¶”ê°€)

```typescript
const { data, error } = await supabase
    .from('users')
    .insert([{ name: 'John', email: 'john@example.com' }])
    .select();
```

#### UPDATE (ìˆ˜ì •)

```typescript
const { data, error } = await supabase.from('users').update({ name: 'Jane' }).eq('id', userId).select();
```

#### DELETE (ì‚­ì œ)

```typescript
const { data, error } = await supabase.from('users').delete().eq('id', userId);
```

### 2. ê´€ê³„í˜• ì¿¼ë¦¬

```typescript
const { data, error } = await supabase
    .from('posts')
    .select(
        `
        *,
        author:users(id, name, email),
        comments(id, content, created_at)
    `
    )
    .eq('status', 'published');
```

### 3. RPC (Remote Procedure Call)

ë³µì¡í•œ ì¿¼ë¦¬ëŠ” Supabaseì˜ PostgreSQL í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```typescript
const { data, error } = await supabase.rpc('get_user_stats', {
    user_id: userId,
    start_date: '2024-01-01',
});
```

### 4. Realtime êµ¬ë…

ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.

```typescript
const channel = supabase
    .channel('users-changes')
    .on(
        'postgres_changes',
        {
            event: '*',
            schema: 'public',
            table: 'users',
        },
        (payload) => {
            console.log('Change received!', payload);
            // Store ì—…ë°ì´íŠ¸ ë˜ëŠ” ì¿¼ë¦¬ ë¬´íš¨í™”
            queryClient.invalidateQueries({ queryKey: ['users'] });
        }
    )
    .subscribe();

// êµ¬ë… í•´ì œ
channel.unsubscribe();
```

### 5. Row Level Security (RLS)

SupabaseëŠ” RLSë¥¼ í†µí•´ ë°ì´í„° ì ‘ê·¼ì„ ì œì–´í•©ë‹ˆë‹¤.

**ì •ì±… ì˜ˆì‹œ (SQL):**

```sql
-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Users can view own data"
ON users FOR SELECT
USING (auth.uid() = id);

-- ì‚¬ìš©ìëŠ” ìì‹ ì˜ ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥
CREATE POLICY "Users can update own data"
ON users FOR UPDATE
USING (auth.uid() = id);
```

---

## ì˜ˆì œ ì½”ë“œ

### ì™„ì „í•œ ì˜ˆì œ: User ê´€ë¦¬

#### 1. íƒ€ì… ì •ì˜

```typescript
// app/_lib/shared/type/database.types.ts
export interface Database {
    public: {
        Tables: {
            users: {
                Row: {
                    id: string;
                    name: string;
                    email: string;
                    created_at: string;
                    updated_at: string;
                };
                Insert: {
                    id?: string;
                    name: string;
                    email: string;
                    created_at?: string;
                    updated_at?: string;
                };
                Update: {
                    id?: string;
                    name?: string;
                    email?: string;
                    created_at?: string;
                    updated_at?: string;
                };
            };
        };
    };
}

export type User = Database['public']['Tables']['users']['Row'];
export type NewUser = Database['public']['Tables']['users']['Insert'];
export type UpdateUser = Database['public']['Tables']['users']['Update'];
```

#### 2. Store ì •ì˜

```typescript
// app/_lib/shared/stores/user/useUserStore.ts
import { create } from 'zustand';
import { User } from '@/app/_lib/shared/type/database.types';

interface UserStore {
    users: User[];
    setUsers: (users: User[]) => void;
    addUser: (user: User) => void;
    updateUser: (id: string, user: Partial<User>) => void;
    removeUser: (id: string) => void;
    reset: () => void;
}

const initialState = {
    users: [],
};

const useUserStore = create<UserStore>((set) => ({
    ...initialState,
    setUsers: (users: User[]) => set({ users }),
    addUser: (user: User) =>
        set((state) => ({
            users: [...state.users, user],
        })),
    updateUser: (id: string, updatedUser: Partial<User>) =>
        set((state) => ({
            users: state.users.map((user) => (user.id === id ? { ...user, ...updatedUser } : user)),
        })),
    removeUser: (id: string) =>
        set((state) => ({
            users: state.users.filter((user) => user.id !== id),
        })),
    reset: () => set(initialState),
}));

export default useUserStore;
```

#### 3. Hook ì •ì˜

```typescript
// app/_lib/shared/hooks/user/useUserHook.ts
'use client';
import { useQuery, useMutation } from '@tanstack/react-query';
import { useEffect } from 'react';
import toast from 'react-hot-toast';
import { supabase } from '@/app/_lib/shared/supabase/client';
import useUserStore from '@/app/_lib/shared/stores/user/useUserStore';
import { queryClient } from '@/app/_lib/shared/tanstack/queryClient';
import { User, NewUser, UpdateUser } from '@/app/_lib/shared/type/database.types';

// Query: ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ
export const useUsers = (enabled: boolean = true) => {
    const setUsers = useUserStore((state) => state.setUsers);

    const queryResult = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            const { data, error } = await supabase.from('users').select('*').order('created_at', { ascending: false });

            if (error) {
                throw error;
            }

            return data as User[];
        },
        enabled,
    });

    useEffect(() => {
        if (queryResult.data && queryResult.isSuccess) {
            setUsers(queryResult.data);
        }
    }, [queryResult.data, queryResult.isSuccess, setUsers]);

    return queryResult;
};

// Query: íŠ¹ì • ì‚¬ìš©ì ì¡°íšŒ
export const useUser = (userId: string | undefined, enabled: boolean = true) => {
    return useQuery({
        queryKey: ['users', userId],
        queryFn: async () => {
            if (!userId) throw new Error('User ID is required');

            const { data, error } = await supabase.from('users').select('*').eq('id', userId).single();

            if (error) {
                throw error;
            }

            return data as User;
        },
        enabled: !!userId && enabled,
    });
};

// Mutation: ì‚¬ìš©ì ì¶”ê°€
export const useAddUser = () => {
    const addUser = useUserStore((state) => state.addUser);

    return useMutation({
        mutationFn: async (newUser: NewUser) => {
            const { data, error } = await supabase.from('users').insert([newUser]).select().single();

            if (error) {
                throw error;
            }

            return data as User;
        },
        onSuccess: (data) => {
            addUser(data);
            queryClient.invalidateQueries({ queryKey: ['users'] });
            toast.success('ì‚¬ìš©ìê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        onError: (error: any) => {
            toast.error('ì‚¬ìš©ì ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            console.error('Add user error:', error);
        },
    });
};

// Mutation: ì‚¬ìš©ì ìˆ˜ì •
export const useUpdateUser = () => {
    const updateUser = useUserStore((state) => state.updateUser);

    return useMutation({
        mutationFn: async ({ id, updates }: { id: string; updates: UpdateUser }) => {
            const { data, error } = await supabase.from('users').update(updates).eq('id', id).select().single();

            if (error) {
                throw error;
            }

            return data as User;
        },
        onSuccess: (data) => {
            updateUser(data.id, data);
            queryClient.invalidateQueries({ queryKey: ['users'] });
            queryClient.invalidateQueries({ queryKey: ['users', data.id] });
            toast.success('ì‚¬ìš©ì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        onError: (error: any) => {
            toast.error('ì‚¬ìš©ì ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            console.error('Update user error:', error);
        },
    });
};

// Mutation: ì‚¬ìš©ì ì‚­ì œ
export const useDeleteUser = () => {
    const removeUser = useUserStore((state) => state.removeUser);

    return useMutation({
        mutationFn: async (userId: string) => {
            const { error } = await supabase.from('users').delete().eq('id', userId);

            if (error) {
                throw error;
            }

            return userId;
        },
        onSuccess: (userId) => {
            removeUser(userId);
            queryClient.invalidateQueries({ queryKey: ['users'] });
            toast.success('ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        },
        onError: (error: any) => {
            toast.error('ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            console.error('Delete user error:', error);
        },
    });
};
```

#### 4. ì»´í¬ë„ŒíŠ¸ì—ì„œ ì‚¬ìš©

```typescript
// ì»´í¬ë„ŒíŠ¸ ì˜ˆì‹œ
'use client';
import { useUsers, useAddUser, useUpdateUser, useDeleteUser } from '@/app/_lib/shared/hooks/user/useUserHook';

export default function UserComponent() {
    // Query ì‚¬ìš©
    const { data: users, isLoading, error } = useUsers();

    // Mutation ì‚¬ìš©
    const addMutation = useAddUser();
    const updateMutation = useUpdateUser();
    const deleteMutation = useDeleteUser();

    const handleAdd = () => {
        addMutation.mutate({
            name: 'John Doe',
            email: 'john@example.com',
        });
    };

    const handleUpdate = (userId: string) => {
        updateMutation.mutate({
            id: userId,
            updates: { name: 'Jane Doe' },
        });
    };

    const handleDelete = (userId: string) => {
        deleteMutation.mutate(userId);
    };

    if (isLoading) return <div>Loading...</div>;
    if (error) return <div>Error occurred</div>;

    return (
        <div>
            <h1>Users</h1>
            {users?.map((user) => (
                <div key={user.id}>
                    <p>
                        {user.name} - {user.email}
                    </p>
                    <button onClick={() => handleUpdate(user.id)}>ìˆ˜ì •</button>
                    <button onClick={() => handleDelete(user.id)}>ì‚­ì œ</button>
                </div>
            ))}
            <button onClick={handleAdd}>ì¶”ê°€</button>
        </div>
    );
}
```

---

## ì£¼ìš” ì›ì¹™ ìš”ì•½

1. **API ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ ë°ì´í„° ì‚¬ìš© ê¸ˆì§€**: ì—ëŸ¬ê°€ ë°œìƒí•˜ë©´ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ê³ , í•˜ë“œì½”ë”©ëœ ëŒ€ì²´ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

2. **Store íŒ¨í„´ ì¤€ìˆ˜**: ëª¨ë“  API í˜¸ì¶œê³¼ ìƒíƒœ ê´€ë¦¬ëŠ” Store íŒ¨í„´ì„ ë”°ë¦…ë‹ˆë‹¤.

3. **ì¤‘ë³µ í™•ì¸**: ìƒˆë¡œìš´ Store ë° API ìƒì„± ì‹œ ê°™ì€ ê¸°ëŠ¥ì˜ API ë° Storeê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

4. **Hookì—ì„œ ì¿¼ë¦¬ ìƒì„±**: ëª¨ë“  ì¿¼ë¦¬ëŠ” Hookì—ì„œ ìƒì„±í•˜ê³ , TanStack Queryë¡œ ê´€ë¦¬í•©ë‹ˆë‹¤.

5. **Storeì—ì„œ ìƒíƒœ ê´€ë¦¬**: í™”ë©´ ê°œë°œ ì‹œ ëª¨ë“  API í˜¸ì¶œê³¼ ìƒíƒœ ê´€ë¦¬ëŠ” Storeì—ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.

6. **ì—ëŸ¬ ì²˜ë¦¬**: ì—ëŸ¬ëŠ” ì ì ˆí•œ ë ˆë²¨ì—ì„œ ì²˜ë¦¬í•˜ê³ , ì‚¬ìš©ìì—ê²Œ ëª…í™•í•œ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.

7. **Supabase ì§ì ‘ í˜¸ì¶œ**: API Routeë¥¼ ê±°ì¹˜ì§€ ì•Šê³  Supabaseë¡œ ì§ì ‘ ë°ì´í„°ë¥¼ ì¡°íšŒ/ë³€ê²½í•©ë‹ˆë‹¤.

8. **RLS í™œìš©**: Row Level Securityë¥¼ í™œìš©í•˜ì—¬ ë°ì´í„° ë³´ì•ˆì„ ê°•í™”í•©ë‹ˆë‹¤.

---

## ì°¸ê³  íŒŒì¼

-   **Supabase í´ë¼ì´ì–¸íŠ¸**: `app/_lib/shared/supabase/client.ts`
-   **TanStack Query ì„¤ì •**: `app/_lib/shared/tanstack/queryClient.ts`
-   **Query Provider**: `app/_lib/shared/providers/QueryProvider.tsx`
-   **Hook ì˜ˆì‹œ**: `app/_lib/shared/hooks/user/useUserHook.ts`
-   **Store ì˜ˆì‹œ**: `app/_lib/shared/stores/user/useUserStore.ts`
-   **íƒ€ì… ì •ì˜**: `app/_lib/shared/type/database.types.ts`

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2024ë…„
